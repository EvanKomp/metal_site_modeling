schema: '2.0'
stages:
  stage_name:
    cmd: python src/parse_site_data.py
    deps:
    - path: data/mf_sites
      hash: md5
      md5: c76890a1546d53affdc3379c72a4ce76.dir
      size: 6655444663
      nfiles: 314974
    - path: src/parse_site_data.py
      hash: md5
      md5: 40a13842e8d48e14435421639d2e3152
      size: 2940
    outs:
    - path: data/metrics/site_label_metrics.json
      hash: md5
      md5: 6fb44b5fced884503be1d47508145ff3
      size: 99
    - path: data/site_labels.csv
      hash: md5
      md5: ec0d15f08c081acc9d39eb7902bf1105
      size: 8570349
  1.2_create_dataset:
    cmd: python pipeline/1.2_create_dataset.py
    deps:
    - path: data/mf_sites
      hash: md5
      md5: 73e0b7eee217068d63aee98df6740fac.dir
      size: 5383821905
      nfiles: 314920
    - path: pipeline/1.2_create_dataset.py
      hash: md5
      md5: 13b38ed5d28e3af40ee6d3be769575ab
      size: 4261
    params:
      params.yaml:
        data.aggregate_uncommon: true
        data.metal_known: false
        data.model_hydrogens: false
        data.test_frac: 0.05
    outs:
    - path: data/dataset/metal_site_dataset
      hash: md5
      md5: 073db9a3f1ea26223777c3abbf416dd7.dir
      size: 3291760765
      nfiles: 13
    - path: data/dataset/tokenizer.pkl
      hash: md5
      md5: 504a06ed37a177a221550fd831fb7f09
      size: 1192
  1.3_get_avg_num_neighbors:
    cmd: python pipeline/1.3_get_avg_num_neighbors.py
    deps:
    - path: data/dataset/metal_site_dataset
      hash: md5
      md5: 073db9a3f1ea26223777c3abbf416dd7.dir
      size: 3291760765
      nfiles: 13
    - path: data/toy_dataset
      hash: md5
      md5: 3477d912e5bc567b74a77975a081b0b1.dir
      size: 22690905
      nfiles: 7
    - path: pipeline/1.3_get_avg_num_neighbors.py
      hash: md5
      md5: a2eaf3d1aa337229613e7f5d144dc299
      size: 1911
    params:
      params.yaml:
        model.max_radius: 5
        training.debug_use_toy: true
    outs:
    - path: data/training_avg_num_neighbors.json
      hash: md5
      md5: c460420ea675e36abedf3530042b6c41
      size: 41
  1.1_parse_site_data:
    cmd: python pipeline/1.1_parse_site_data.py
    deps:
    - path: data/mf_sites
      hash: md5
      md5: 73e0b7eee217068d63aee98df6740fac.dir
      size: 5383821905
      nfiles: 314920
    - path: pipeline/1.1_parse_site_data.py
      hash: md5
      md5: 40a13842e8d48e14435421639d2e3152
      size: 2940
    outs:
    - path: data/metrics/site_label_metrics.json
      hash: md5
      md5: 6fb44b5fced884503be1d47508145ff3
      size: 99
    - path: data/site_labels.csv
      hash: md5
      md5: ec0d15f08c081acc9d39eb7902bf1105
      size: 8570349
  2.1_self_supervised_training:
    cmd: accelerate launch pipeline/2.1_self_supervised_training.py
    deps:
    - path: data/dataset/metal_site_dataset
      hash: md5
      md5: 073db9a3f1ea26223777c3abbf416dd7.dir
      size: 3291760765
      nfiles: 13
    - path: data/dataset/tokenizer.pkl
      hash: md5
      md5: 504a06ed37a177a221550fd831fb7f09
      size: 1192
    - path: data/metrics/null_model_metrics.json
      hash: md5
      md5: 64d77917311f11361edcfd1fbc5ece07
      size: 489
    - path: data/toy_dataset
      hash: md5
      md5: 3477d912e5bc567b74a77975a081b0b1.dir
      size: 22690905
      nfiles: 7
    - path: data/training_avg_num_neighbors.json
      hash: md5
      md5: c460420ea675e36abedf3530042b6c41
      size: 41
    - path: pipeline/2.1_self_supervised_training.py
      hash: md5
      md5: 8588afa72e4a1f89f40270e16c51098c
      size: 8712
    params:
      params.yaml:
        embedding.hdbscan_alpha: 1.0
        embedding.hdbscan_min_cluster_size: 5
        embedding.hdbscan_min_samples: 5
        embedding.hidden_state: -1
        embedding.how: <METAL>_mean
        embedding.tsne_learning_rate: auto
        embedding.tsne_n_iter: 1000
        embedding.tsne_perplexity: 30
        model.alpha_drop: 0.0
        model.atom_embed_dim: 32
        model.drop_path_rate: 0.0
        model.fc_neurons:
        - 64
        - 64
        model.hidden_scale: 128
        model.hidden_scale_decay: 0.25
        model.imbalance_loss_reweight: true
        model.imbalance_loss_temperature: 0.3
        model.l: 2
        model.label_smoothing_factor: 0.1
        model.max_radius: 5
        model.model_atom_types: false
        model.num_basis: 128
        model.num_heads: 8
        model.num_layers: 18
        model.proj_drop: 0.0
        training.dataloader_num_workers: 1
        training.debug_sample:
        training.debug_use_toy: true
        training.early_stopping_improvement_fraction: 0.001
        training.early_stopping_patience: 5
        training.eval_steps: 50
        training.frac_noise_loss: 0.5
        training.gradient_accumulation_steps: 25
        training.gradient_clipping: 1.0
        training.learning_rate: 5e-05
        training.load_best_model_at_end: true
        training.logging_steps: 5
        training.mask_rate: 0.15
        training.noise_rate: 0.15
        training.noise_scale: 0.7
        training.num_epochs: 20
        training.per_device_batch_size: 6
        training.use_early_stopping: false
        training.warmup_pct: 0.1
        training.weight_decay: 0.001
    outs:
    - path: data/model_pretraining/checkpoints
      hash: md5
      md5: b94e6ef308827a8731cca839f9b0065a.dir
      size: 41413532552
      nfiles: 1200
    - path: data/model_pretraining/dvclive/metrics.json
      hash: md5
      md5: 99f5e74c88de927a014680e582d3fd0b
      size: 501
    - path: data/model_pretraining/dvclive/plots/custom/eval_2d_space.json
      hash: md5
      md5: 88ddbd926f90a9a190def492e8c4872b
      size: 78594
    - path: data/model_pretraining/dvclive/plots/metrics
      hash: md5
      md5: 2d5550e0071b416d66b387984833c1df.dir
      size: 123143
      nfiles: 11
    - path: data/model_pretraining/eval_2d_space
      hash: md5
      md5: a9d019690672f52802b6379b892c1f08.dir
      size: 3705843
      nfiles: 151
    - path: data/model_pretraining/final_model
      hash: md5
      md5: 9e549c086281c0bb1ab9bbadc90dd2b7.dir
      size: 98395587
      nfiles: 2
    - path: data/plots/atom_weights.png
      hash: md5
      md5: 69a6f73c38f25fe5b1d91c211c44dcf8
      size: 54229
  1.4_compute_null_model:
    cmd: python pipeline/1.4_compute_null_model.py
    deps:
    - path: data/dataset/metal_site_dataset
      hash: md5
      md5: 073db9a3f1ea26223777c3abbf416dd7.dir
      size: 3291760765
      nfiles: 13
    - path: data/dataset/tokenizer.pkl
      hash: md5
      md5: 504a06ed37a177a221550fd831fb7f09
      size: 1192
    - path: data/toy_dataset
      hash: md5
      md5: 3477d912e5bc567b74a77975a081b0b1.dir
      size: 22690905
      nfiles: 7
    - path: pipeline/1.4_compute_null_model.py
      hash: md5
      md5: aab2434b5a4ff7f963e999ebff4c5a4a
      size: 3991
    params:
      params.yaml:
        training.debug_use_toy: true
        training.mask_rate: 0.15
        training.noise_rate: 0.15
        training.noise_scale: 0.7
    outs:
    - path: data/metrics/null_model_metrics.json
      hash: md5
      md5: 64d77917311f11361edcfd1fbc5ece07
      size: 489
