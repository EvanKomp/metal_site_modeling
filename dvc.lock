schema: '2.0'
stages:
  stage_name:
    cmd: python src/parse_site_data.py
    deps:
    - path: data/mf_sites
      hash: md5
      md5: c76890a1546d53affdc3379c72a4ce76.dir
      size: 6655444663
      nfiles: 314974
    - path: src/parse_site_data.py
      hash: md5
      md5: 40a13842e8d48e14435421639d2e3152
      size: 2940
    outs:
    - path: data/metrics/site_label_metrics.json
      hash: md5
      md5: 6fb44b5fced884503be1d47508145ff3
      size: 99
    - path: data/site_labels.csv
      hash: md5
      md5: ec0d15f08c081acc9d39eb7902bf1105
      size: 8570349
  1.2_create_dataset:
    cmd: python pipeline/1.2_create_dataset.py
    deps:
    - path: data/mf_sites
      hash: md5
      md5: 73e0b7eee217068d63aee98df6740fac.dir
      size: 5383821905
      nfiles: 314920
    - path: pipeline/1.2_create_dataset.py
      hash: md5
      md5: 13b38ed5d28e3af40ee6d3be769575ab
      size: 4261
    params:
      params.yaml:
        data.aggregate_uncommon: true
        data.metal_known: false
        data.model_hydrogens: false
        data.test_frac: 0.05
    outs:
    - path: data/dataset/metal_site_dataset
      hash: md5
      md5: 073db9a3f1ea26223777c3abbf416dd7.dir
      size: 3291760765
      nfiles: 13
    - path: data/dataset/tokenizer.pkl
      hash: md5
      md5: 504a06ed37a177a221550fd831fb7f09
      size: 1192
  1.3_get_avg_num_neighbors:
    cmd: python pipeline/1.3_get_avg_num_neighbors.py
    deps:
    - path: data/dataset/metal_site_dataset
      hash: md5
      md5: 073db9a3f1ea26223777c3abbf416dd7.dir
      size: 3291760765
      nfiles: 13
    - path: data/toy_dataset
      hash: md5
      md5: 23e7de7e853521da1a4d742c1449385b.dir
      size: 5729997
      nfiles: 7
    - path: pipeline/1.3_get_avg_num_neighbors.py
      hash: md5
      md5: a2eaf3d1aa337229613e7f5d144dc299
      size: 1911
    params:
      params.yaml:
        model.max_radius: 5
        training.debug_use_toy: true
    outs:
    - path: data/training_avg_num_neighbors.json
      hash: md5
      md5: 43f278081b69181da7acf74638a3c775
      size: 40
  1.1_parse_site_data:
    cmd: python pipeline/1.1_parse_site_data.py
    deps:
    - path: data/mf_sites
      hash: md5
      md5: 73e0b7eee217068d63aee98df6740fac.dir
      size: 5383821905
      nfiles: 314920
    - path: pipeline/1.1_parse_site_data.py
      hash: md5
      md5: 40a13842e8d48e14435421639d2e3152
      size: 2940
    outs:
    - path: data/metrics/site_label_metrics.json
      hash: md5
      md5: 6fb44b5fced884503be1d47508145ff3
      size: 99
    - path: data/site_labels.csv
      hash: md5
      md5: ec0d15f08c081acc9d39eb7902bf1105
      size: 8570349
  2.1_self_supervised_training:
    cmd: accelerate launch pipeline/2.1_self_supervised_training.py
    deps:
    - path: data/dataset/metal_site_dataset
      hash: md5
      md5: 073db9a3f1ea26223777c3abbf416dd7.dir
      size: 3291760765
      nfiles: 13
    - path: data/dataset/tokenizer.pkl
      hash: md5
      md5: 504a06ed37a177a221550fd831fb7f09
      size: 1192
    - path: data/metrics/null_model_metrics.json
      hash: md5
      md5: 9fbe142c783d8dd05c808e703935fad8
      size: 211
    - path: data/toy_dataset
      hash: md5
      md5: 23e7de7e853521da1a4d742c1449385b.dir
      size: 5729997
      nfiles: 7
    - path: data/training_avg_num_neighbors.json
      hash: md5
      md5: 43f278081b69181da7acf74638a3c775
      size: 40
    - path: pipeline/2.1_self_supervised_training.py
      hash: md5
      md5: 1194368b36848f579e3eeeda03a21b3d
      size: 9150
    params:
      params.yaml:
        embedding.hdbscan_alpha: 1.0
        embedding.hdbscan_min_cluster_size: 5
        embedding.hdbscan_min_samples: 5
        embedding.hidden_state: -1
        embedding.how: all_mean
        embedding.tsne_learning_rate: auto
        embedding.tsne_n_iter: 1000
        embedding.tsne_perplexity: 30
        model.alpha_drop: 0.0
        model.atom_embed_dim: 32
        model.drop_path_rate: 0.0
        model.fc_neurons:
        - 64
        - 64
        model.hidden_scale: 128
        model.hidden_scale_decay: 0.25
        model.imbalance_loss_reweight: true
        model.imbalance_loss_temperature: 0.3
        model.l: 2
        model.label_smoothing_factor: 0.1
        model.max_radius: 5
        model.model_atom_types: false
        model.num_basis: 128
        model.num_heads: 8
        model.num_layers: 18
        model.proj_drop: 0.0
        training.dataloader_num_workers: 1
        training.debug_sample:
        training.debug_use_toy: true
        training.early_stopping_improvement_fraction: 0.001
        training.early_stopping_patience: 5
        training.eval_steps: 50
        training.frac_noise_loss: 0.5
        training.gradient_accumulation_steps: 25
        training.gradient_clipping: 1.0
        training.learning_rate: 5e-05
        training.load_best_model_at_end: true
        training.logging_steps: 5
        training.mask_rate: 0.15
        training.noise_rate: 0.15
        training.noise_scale: 0.7
        training.num_epochs: 500
        training.per_device_batch_size: 12
        training.use_early_stopping: false
        training.warmup_pct: 0.1
        training.weight_decay: 0.001
    outs:
    - path: data/model_pretraining/checkpoints
      hash: md5
      md5: 87f761b82a73faa073bbef06c997df09.dir
      size: 143938935828
      nfiles: 3912
    - path: data/model_pretraining/dvclive/metrics.json
      hash: md5
      md5: ae6cf5cb40f8f5157b6ca032cf244401
      size: 493
    - path: data/model_pretraining/dvclive/plots/custom/eval_2d_space.json
      hash: md5
      md5: 89dba3ad26c2aa106ee164b9f46e5545
      size: 78513
    - path: data/model_pretraining/dvclive/plots/metrics
      hash: md5
      md5: 75d9f0fde2a8441d05c1063e5aa9e63c.dir
      size: 420358
      nfiles: 11
    - path: data/model_pretraining/eval_2d_space
      hash: md5
      md5: 927224246b668d8929f3a1f444f7a6f5.dir
      size: 12022285
      nfiles: 490
    - path: data/model_pretraining/final_model
      hash: md5
      md5: d751713988987e9331980363e24189ce.dir
      size: 0
      nfiles: 0
    - path: data/plots/atom_weights.png
      hash: md5
      md5: 90befd70010379d46169e2f9a22289ce
      size: 35601
  1.4_compute_null_model:
    cmd: python pipeline/1.4_compute_null_model.py
    deps:
    - path: data/dataset/metal_site_dataset
      hash: md5
      md5: 073db9a3f1ea26223777c3abbf416dd7.dir
      size: 3291760765
      nfiles: 13
    - path: data/dataset/tokenizer.pkl
      hash: md5
      md5: 504a06ed37a177a221550fd831fb7f09
      size: 1192
    - path: data/toy_dataset
      hash: md5
      md5: 23e7de7e853521da1a4d742c1449385b.dir
      size: 5729997
      nfiles: 7
    - path: pipeline/1.4_compute_null_model.py
      hash: md5
      md5: aab2434b5a4ff7f963e999ebff4c5a4a
      size: 3991
    params:
      params.yaml:
        training.debug_use_toy: true
        training.mask_rate: 0.15
        training.noise_rate: 0.15
        training.noise_scale: 0.7
    outs:
    - path: data/metrics/null_model_metrics.json
      hash: md5
      md5: 9fbe142c783d8dd05c808e703935fad8
      size: 211
  1.1_parse_sites_metadata:
    cmd: python pipeline/1/1.1_parse_sites_metadata.py
    deps:
    - path: data/edquality_mapper_cache
      hash: md5
      md5: 3b5ac7a0fa27ca0f52565b0b575a319c
      size: 50980364
    - path: metalsitenn/dataloading.py
      hash: md5
      md5: 870079722ae8db41ccff42256b0b7468
      size: 36783
    - path: metalsitenn/placer_modules/cifutils.py
      hash: md5
      md5: 723a8f98829673c969575fe71103f551
      size: 106626
    - path: pipeline/1/1.1_parse_sites_metadata.py
      hash: md5
      md5: 2d23a4f4bec768fb66986532e945667d
      size: 5666
    params:
      params.yaml:
        data.backbone_treatment: free
        data.coordination_distance: 2.9
        data.debug_max_files:
        data.max_atoms_per_site: 400
        data.max_water_bfactor: 18
        data.metal_aggregation_distance: 4
        data.metal_site_radius: 6
        data.min_coordinating_residues_per_site: 3
        data.min_residues_per_site: 3
        data.n_cores: 104
        data.remove_entities:
        - SO4
        - PO4
        - CL
        - BR
        - I
        - NO3
        - ACT
        - FMT
        - TRS
        - BIC
        - TRA
        - MES
        - BIS
        - EPE
        - IMD
        - GOL
        - ETG
        - PEG
        - PG4
        - PGE
        - MPD
        - DMS
        - SUC
        - TRE
        - XYL
        - ERY
        - ACE
        - EOH
        - MOH
        - IPA
        - BUT
        - DMF
        - DMSO
        - LDA
        - OP1
        - C8E
        - DDM
        - BOG
        - LMT
        - IOD
        - XE
        - KR
        - BCB
        - BTB
        - CR
        - MB
        - UNX
        - UNL
        - UNK
        - DUM
        - AMS
        - LIS
        - CAS
        - MPO
        - NEP
        - PEN
        - HEX
        data.skip_sites_with_entities:
        data.source: /datasets/alphafold_data/data_v2/pdb_mmcif/mmcif_files
    outs:
    - path: data/1/1.1_parse_sites_metadata
      hash: md5
      md5: 580bf7536778cccd32156a5bca57f386.dir
      size: 634283309
      nfiles: 43193
  1.0_construct_edquality_mapper:
    cmd: python pipeline/1/1.0_construct_edquality_mapper.py
    deps:
    - path: data/edstats_pdb_quality.csv
      hash: md5
      md5: a4d441291c5c6e0dbee1f637a79374c7
      size: 14187832
    params:
      params.yaml:
        data.source: /datasets/alphafold_data/data_v2/pdb_mmcif/mmcif_files
    outs:
    - path: data/edquality_mapper_cache
      hash: md5
      md5: 3b5ac7a0fa27ca0f52565b0b575a319c
      size: 50980364
  2.0_get_stats:
    cmd: python pipeline/2_pretraining/2.0_get_stats.py
    deps:
    - path: data/1/1.1_parse_sites_metadata
      hash: md5
      md5: 580bf7536778cccd32156a5bca57f386.dir
      size: 634283309
      nfiles: 43193
    params:
      params.yaml:
        2_pretraining.data.dataloader_n_processes: 8
        2_pretraining.data.debug_max_sites:
        2_pretraining.data.filtering:
          valid_metals:
          min_metals:
          max_metals:
          min_organic_ligands:
          max_organic_ligands:
          min_waters:
          max_waters:
          min_nucleotides:
          max_nucleotides:
          min_amino_acids: 4
          max_amino_acids:
          min_co_amino_acids: 2
          max_co_amino_acids:
          min_sites_per_pdb:
          max_sites_per_pdb:
          max_unresolved_removed: 0
          max_resolution: 3.5
          max_max_rczd:
        2_pretraining.data.tokenization:
          atom_features:
          - element
          - charge
          - nhyd
          - hyb
          bond_features:
          - bond_order
          - is_in_ring
          - is_aromatic
          k: 20
          node_mlm_do: true
          node_mlm_rate: 0.15
          node_mlm_subrate_tweak: 0.0
          node_mlm_subrate_keep: 0.1
          residue_collapse_do: false
          residue_collapse_rate: 0.0
          residue_collapse_other_atom_noise_sigma: 0.1
          active_aggregators:
          - unknown_metal
    outs:
    - path: data/2/2.0/element_counts.json
      hash: md5
      md5: cb7fc5d0938cb1fa3ced07942cae5d2c
      size: 454
    - path: data/metrics/2/2.0/data_stats.json
      hash: md5
      md5: 94c1ee66703cd752a356afb7039f1eff
      size: 1810
  2.1_compute_node_class_weights:
    cmd: python pipeline/2_pretraining/2.1_compute_node_class_weights.py
    deps:
    - path: data/2/2.0/element_counts.json
      hash: md5
      md5: cb7fc5d0938cb1fa3ced07942cae5d2c
      size: 454
    params:
      params.yaml:
        2_pretraining.data.loss_weighting.cel_count_to_weight_clip_token: 
          <METAL>
        2_pretraining.data.loss_weighting.cel_count_to_weight_temperature: 2.0
        2_pretraining.data.tokenization.active_aggregators:
        - unknown_metal
    outs:
    - path: data/2/2.1/node_class_weights.json
      hash: md5
      md5: 6f6b5bf818e74563aa56b2067ac46161
      size: 1658
    - path: data/plots/2/2.1/node_class_weights.png
      hash: md5
      md5: 943f88ba3dcb697abafb71c60e7fd708
      size: 416043
  2.3_training:
    cmd: accelerate launch --config_file 
      accelerate_configs/one_process_full_precision.yaml 
      pipeline/2_pretraining/2.3_training.py
    deps:
    - path: data/1/1.1_parse_sites_metadata
      hash: md5
      md5: 580bf7536778cccd32156a5bca57f386.dir
      size: 634283309
      nfiles: 43193
    - path: data/2/2.1/node_class_weights.json
      hash: md5
      md5: 6f6b5bf818e74563aa56b2067ac46161
      size: 1658
    params:
      params.yaml:
        2_pretraining.accelerate_config: 
          accelerate_configs/one_process_full_precision.yaml
        2_pretraining.data.debug_max_sites:
        2_pretraining.data.splitting:
          test_frac: 0.1
          val_frac_of_train: 0.05
          seed: 42
        2_pretraining.data.tokenization:
          atom_features:
          - element
          - charge
          - nhyd
          - hyb
          bond_features:
          - bond_order
          - is_in_ring
          - is_aromatic
          k: 20
          node_mlm_do: true
          node_mlm_rate: 0.15
          node_mlm_subrate_tweak: 0.0
          node_mlm_subrate_keep: 0.1
          residue_collapse_do: false
          residue_collapse_rate: 0.0
          residue_collapse_other_atom_noise_sigma: 0.1
          active_aggregators:
          - unknown_metal
        2_pretraining.model:
          num_layers: 12
          sphere_channels: 128
          attn_hidden_channels: 64
          num_heads: 8
          attn_alpha_channels: 64
          attn_value_channels: 16
          ffn_hidden_channels: 128
          norm_type: layer_norm_sh
          lmax_list:
          - 3
          mmax_list:
          grid_resolution: 18
          num_distance_basis: 512
          distance_function: gaussian
          max_radius: 12.0
          embedding_dim: 32
          edge_degree_projector_hidden_layers: 2
          edge_degree_projector_size: 128
          edge_channels_list:
          use_m_share_rad: false
          attn_activation: silu
          use_s2_act_attn: false
          use_attn_renorm: true
          ffn_activation: silu
          use_gate_act: false
          use_grid_mlp: true
          use_sep_s2_act: true
          alpha_drop: 0.1
          drop_path_rate: 0.1
          proj_drop: 0.0
          weight_init: uniform
          use_topology_gradients: true
          topology_gradient_clip: 100.0
          use_time: false
          film_time_embedding_dim: 128
          film_hidden_dim: 128
          film_mlp_layers: 2
          film_num_gaussians: 512
          film_basis_function: gaussian
          node_class_weights: true
          node_class_label_smoothing: 0.0
          film_l2_loss_weight: 0.0
        2_pretraining.training:
          max_epochs: 100
          eval_every: 50
          log_every: 10
          max_checkpoints: 5
          save_best_only: true
          lr_initial: 0.0001
          scheduler: LambdaLR
          lambda_type: cosine
          warmup_epochs: 0
          warmup_factor: 0.2
          lr_min_factor: 0.01
          decay_epochs:
          decay_rate: 0.1
          optimizer: AdamW
          batch_size: 32
          gradient_accumulation_steps: 1
          weight_decay: 0.0
          clip_grad_norm: 1.0
          ema_decay:
          seed:
          run_dir: data/2/2.3_pretraining
          overwrite_output_dir: true
          primary_metric: val/loss
          node_level_metrics: false
          patience:
          min_delta: 0.0
          resume_from_checkpoint:
          reset_optimizer: false
          num_workers: 8
          pin_memory: true
          drop_last: true
          shuffle: true
          run_val_at_start: true
    outs:
    - path: data/2/2.3_pretraining/checkpoints
      hash: md5
      md5: d751713988987e9331980363e24189ce.dir
      size: 0
      nfiles: 0
    - path: data/2/2.3_pretraining/dvclive/plots/metrics
      hash: md5
      md5: 5ae88db1ca5db926e6c6d8e1aca53095.dir
      size: 8499
      nfiles: 2
